<HTML>
<HEAD>
<TITLE>B<mtop> - Shows top mysql threads</TITLE>
<LINK REV="made" HREF="mailto:systems@chelsea.net">
</HEAD>

<BODY>

<A NAME="__index__"></A>
<!-- INDEX BEGIN -->

<UL>

	<LI><A HREF="#name">NAME</A></LI>
	<LI><A HREF="#synopsis">SYNOPSIS</A></LI>
	<LI><A HREF="#description">DESCRIPTION</A></LI>
	<LI><A HREF="#options">OPTIONS</A></LI>
	<LI><A HREF="#setup">SETUP</A></LI>
	<LI><A HREF="#author">AUTHOR</A></LI>
	<LI><A HREF="#bugs">BUGS</A></LI>
	<LI><A HREF="#todo">TODO</A></LI>
</UL>
<!-- INDEX END -->

<HR>
<P>
<H1><A NAME="name">NAME</A></H1>
<P><STRONG>mtop</STRONG> - Shows top mysql threads</P>
<P>
<HR>
<H1><A NAME="synopsis">SYNOPSIS</A></H1>
<PRE>
    mtop [--host={mysql_host}] [--dbuser={mysql_user}] 
        [--password={mysqluser_pw}] [--seconds={refresh}] [--[no]idle] 
        [--filter-user={regex}] [--filter-host={regex}] [--filter-db={regex}]
        [--filter-command={regex}] [--filter-state={regex}] [--filter-info={{regex}}]
        [--user={user}] [--manualrefresh]</PRE>
<PRE>
    mtop --help</PRE>
<PRE>
    mtop --version</PRE>
<P>
<HR>
<H1><A NAME="description">DESCRIPTION</A></H1>
<P>Shows the MySQL commands consuming the greatest time.  By default, only non-sleeping 
threads are shown, the <STRONG>--idle</STRONG> option shows idle threads.  While running several 
keys will affect the operation of <STRONG>mtop</STRONG>.  Hitting <STRONG>h</STRONG> or <STRONG>?</STRONG> will show the 
available options.</P>
<P>Normally, run as a console program this will allow you to see errant or badly 
optimized queries as they will stay on the screen for a while.  However, if you
are hunting for short lived queries, running in the <STRONG>manualrefresh</STRONG> mode with a 
short refresh time will allow you to catch short lived queries as well.</P>
<P>The following keys are active while mtop is running:</P>
<PRE>
    q - quit
    ? - help</PRE>
<PRE>
    Filtering/display</PRE>
<PRE>
    s - change the number of seconds to delay between updates
    m - toggle manual refresh mode on/off
    d - filter display with regular expression (user/host/db/command/state/info)
    h - display process for only one host
    u - display process for only one user
    i - toggle all/non-Sleeping process display
    o - reverse the sort order</PRE>
<PRE>
    Control/Detail</PRE>
<PRE>
    k - kill processes; send a kill to a list of ids
    e - explain a process; show query optimizer info
    z - zoom in on a process; show sql statement detail 
    f - flush stats (reset show status variables)
    t - show mysqld stats (show status/mysqladmin ext)
    v - show mysqld variables (show variables/mysqladmin vars)
    r - show replication status for master/slaves</PRE>
<P><STRONG>Statistics/Variables</STRONG></P>
<P>When viewing the <EM>stats</EM> screen, the screen will refresh until a key is 
pressed at which point you will return to the main screen.  The bottom of the 
<EM>stats</EM> screen is denoted with a line containing <STRONG>---</STRONG>, if you do not see
that line, resize your screen until you do.</P>
<P>The <EM>variables</EM> screen only shows the information once and returns to the main 
screen as the variables do not change after server startup.</P>
<P><STRONG>Replication</STRONG></P>
<P>The replication monitor screen looks for a master or slave server running on the currently
monitored mysqld.  If a master server is found, it then tries to connect to each slave
connected to the master.  Replication is shown for all masters and slaves found.
Offsets from the master for each of the slaves is shown.  Note: the offset may be less
than zero because the slave position is checked after the master position.  The offset
shown is the number of queries in the binlog that the slave has to process before
being caught up with the master.</P>
<P>
<HR>
<H1><A NAME="options">OPTIONS</A></H1>
<P>All options can be abbreviated by their shortest unique abbreviation.</P>
<DL>
<DT><STRONG><A NAME="item_%2D%3F%2C_%2D%2Dhelp">-?, --help</A></STRONG><BR>
<DD>
Show the help screen and exit.
<P></P>
<DT><STRONG><A NAME="item_%2Dv%2C_%2D%2Dversion">-v, --version</A></STRONG><BR>
<DD>
Show the version number and exit.
<P></P>
<DT><STRONG><A NAME="item_%2Dh_%7Bmysql_host%7D%2C_%2D%2Dhost%3D%7Bmysql_hos">-h {mysql_host}, --host={mysql_host}</A></STRONG><BR>
<DD>
By default, the mysqld on localhost is monitored.  Specify an alternate host
with this option.
<P></P>
<DT><STRONG><A NAME="item_%2Ddbu_%7Bmysql_user%7D%2C_%2D%2Ddbuser%3D%7Bmysql">-dbu {mysql_user}, --dbuser={mysql_user}</A></STRONG><BR>
<DD>
By default, the user 'mysqltop' is used to connect to the database.  Specify an alternate user with this option.
<P></P>
<DT><STRONG><A NAME="item_%2Dp_%7Bmysqluser_pw%7D%2C_%2D%2Dpassword%3D%7Bmys">-p {mysqluser_pw}, --password={mysqluser_pw}</A></STRONG><BR>
<DD>
By default, there is no password associated with the mysqltop
user, specify a password with this option.
<P></P>
<DT><STRONG><A NAME="item_%2Ds_%7Brefresh%7D%2C_%2D%2Dseconds%3D%7Brefresh%7">-s {refresh}, --seconds={refresh}</A></STRONG><BR>
<DD>
The default screen refresh is 5 seconds.
<P></P>
<DT><STRONG><A NAME="item_%2Di%2C_%2D%2D%5Bno%5Didle">-i, --[no]idle</A></STRONG><BR>
<DD>
By default, processes in the <STRONG>Sleep</STRONG> command state are not shown.  This option turns
on display of idle threads.
<P></P>
<DT><STRONG><A NAME="item_%2Du_%7Buser%7D%2C_%2D%2Duser%3D%7Buser%7D">-u {user}, --user={user}</A></STRONG><BR>
<DD>
Show only threads owned by this user.
<P></P>
<DT><STRONG><A NAME="item_%2Dfu_%7Bregex_pattern%7D%2C_%2D%2Dfilter%2Duser%3">-fu {regex_pattern}, --filter-user={regex_pattern}</A></STRONG><BR>
<DD>
<DT><STRONG><A NAME="item_%2Dfh_%7Bregex_pattern%7D%2C_%2D%2Dfilter%2Dhost%3">-fh {regex_pattern}, --filter-host={regex_pattern}</A></STRONG><BR>
<DD>
<DT><STRONG><A NAME="item_%2Dfd_%7Bregex_pattern%7D%2C_%2D%2Dfilter%2Ddb%3D%">-fd {regex_pattern}, --filter-db={regex_pattern}</A></STRONG><BR>
<DD>
<DT><STRONG><A NAME="item_%2Dfs_%7Bregex_pattern%7D%2C_%2D%2Dfilter%2Dstate%">-fs {regex_pattern}, --filter-state={regex_pattern}</A></STRONG><BR>
<DD>
<DT><STRONG><A NAME="item_%2Dfc_%7Bregex_pattern%7D%2C_%2D%2Dfilter%2Dcomman">-fc {regex_pattern}, --filter-command={regex_pattern}</A></STRONG><BR>
<DD>
<DT><STRONG><A NAME="item_%2Dfi_%7Bregex_pattern%7D%2C_%2D%2Dfilter%2Dinfo%3">-fi {regex_pattern}, --filter-info={regex_pattern}</A></STRONG><BR>
<DD>
Filter the display based on the <STRONG>regex_pattern</STRONG> provided.  The <STRONG>regex_pattern</STRONG> is a perl
regular expression.  The regular expression match is done with case insensitivity.
<P>For example, to only show <STRONG>select</STRONG> statements on the <STRONG>user</STRONG> table, use the following:</P>
<PRE>
    --filter-info='select from user'</PRE>
<P>or, to be more forgiving for mutil-table joins and extra spaces, use:</P>
<PRE>
    --filter-info='select\s+from\s+.*\buser\b.*where'</PRE>
<P>These same regular expression filters can be used with the interactive <STRONG>d</STRONG> command.
Be careful to escape any special shell characters in the regex.</P>
<P></P>
<DT><STRONG><A NAME="item_%2Dm%2C_%2D%2Dmanualrefresh">-m, --manualrefresh</A></STRONG><BR>
<DD>
In this mode, the screen only refreshes when the user hits a key on the
keyboard.  The screen will refresh automatically until a query is seen and then wait for 
further input.  An uppercase M will appear in the top right hand corner of the screen to 
indicate that you are in this mode.
<P></P></DL>
<P>
<HR>
<H1><A NAME="setup">SETUP</A></H1>
<P>The most convenient way to setup your system to use <STRONG>mtop</STRONG> is to create a database user
called <STRONG>mysqltop</STRONG> which has no password.  For security purposes, this user should have 
all privileges set to <STRONG>N</STRONG> except <STRONG>Process_priv</STRONG> which must be set to <STRONG>Y</STRONG>.</P>
<P>To grant these privileges, execute the following from the MySQL command prompt</P>
<PRE>
    mysql&gt; grant select on test.* to mysqltop;
    mysql&gt; grant select on test.* to mysqltop@localhost;
    mysql&gt; update user set process_priv='y' where user='mysqltop';
    mysql&gt; flush privileges;</PRE>
<P>Note: GRANT only works in MySQL 3.22.11 or later, for earlier versions add the user
manually and fix the permissions as noted above.  Note 2: the GRANT to mysqltop and
mysqltop@localhost may be modified depending upon which hosts you want to grant
access from.  In general, you probably want to limit it to the hosts in your
domain.</P>
<P>In addition, the <STRONG>mysqltop</STRONG> user must have <STRONG>Select_priv</STRONG> to the <STRONG>test</STRONG> database.  This 
requirement is only needed because the DBI driver requires a database to connect to even
though no database commands are issued.  Most commands this program issues are non-database
specific (SHOW FULL PROCESSLIST, SHOW VARIABLES, KILL id).  When database-specific
commands are needed, mtop will prompt for a username/password if the default one fails.</P>
<P>To install mtop, run the following shell commands:</P>
<PRE>
    perl Makefile.PL
    make
    make install</PRE>
<P>The default {install_prefix} is /usr/local which means that mtop is installed 
in /usr/local/bin/.  To change this, run:</P>
<PRE>
    perl Makefile.PL --prefix={install_prefix}
</PRE>
<PRE>

or modify the PREFIX line in Makefile.PL.</PRE>
<P>Requires DBD::mysql, Curses, and Net::Domain.</P>
<P>
<HR>
<H1><A NAME="author">AUTHOR</A></H1>
<P>Marc Prewitt, Chelsea Networks &lt;<A HREF="mailto:mprewitt@chelsea.net">mprewitt@chelsea.net</A>&gt;</P>
<P>Copyright (C) 2002 Marc Prewitt/Chelsea Networks, under the GNU GPL.
mtop comes with ABSOLUTELY NO WARRANTY. This is free software, and you are
welcome to redistribute it under certain conditions; see the COPYING file 
for details.</P>
<P>
<HR>
<H1><A NAME="bugs">BUGS</A></H1>
<P>Win2K telnet.exe - If you are using the Windows 2000 telnet program, it defaults
to ansi mode which doesn't work well with curses (in my testing on Solaris 8).  
To work around this, set the terminal type to vt100.  To do this, issue the
following command from the telnet prompt before connecting to a host:</P>
<PRE>
    set term vt100</PRE>
<P>Alternatively, you can manually set your TERM environment variable to vt100
after you are logged in.</P>
<P>
<HR>
<H1><A NAME="todo">TODO</A></H1>
<P>Feature to allow regex filters on other display columns.  Show
current filters.</P>
<P>Offer sorts by other columns</P>
<P>For the 'More:' paging, it would be nice to support 'Less' behaviour.</P>
<P>Add support for saving commandline opts in ~/.mtop</P>
<P>Add 'n' command and properly calculate number of lines on screen.</P>
<PRE>
    $Id: mtop.PL,v 1.49 2002/06/30 03:18:34 mdprewitt Exp $</PRE>

</BODY>

</HTML>
